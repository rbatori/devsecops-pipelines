name: SAST - Semgrep Enterprise Mode

on:
  workflow_call:

jobs:
  semgrep:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    container:
      image: semgrep/semgrep:1.76.0  # versão estável fixa

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep Scan
        run: |
          semgrep scan \
            --config p/security-audit \
            --config p/python \
            --config p/secrets \
            --config p/owasp-top-ten \
            --config p/ci \
            --config p/r2c-security-audit \
            --severity ERROR \
            --include '**/*.py' \
            --exclude '*.pdf' \
            --exclude '*.png' \
            --exclude '*.jpg' \
            --exclude '*.jpeg' \
            --exclude '*.svg' \
            --exclude '*.zip' \
            --exclude '*.tar' \
            --exclude '*.gz' \
            --exclude '*.exe' \
            --exclude '*.dll' \
            --exclude '*.bin' \
            --exclude 'node_modules/' \
            --exclude 'dist/' \
            --exclude 'build/' \
            --exclude '__pycache__/' \
            --json \
            --output semgrep.json || true
            
      - name: Annotate findings and fail if HIGH
        run: |
          COUNT=$(jq '[.results[] | select(.extra.severity=="ERROR")] | length' semgrep.json)
      
          if [ "$COUNT" -gt 0 ]; then
            echo ""
            echo "========================================="
            echo " HIGH SEVERITY FINDINGS DETECTED: $COUNT"
            echo "========================================="
            echo ""
      
            jq -r '
              .results[]
              | select(.extra.severity=="ERROR")
              | "----------------------------------------\n" +
                "Rule: " + .check_id + "\n" +
                "Severity: " + .extra.severity + "\n" +
                "File: " + .path + "\n" +
                "Line: " + (.start.line|tostring) + "\n" +
                "Column: " + (.start.col|tostring) + "\n" +
                "Message: " + .extra.message + "\n" +
                "----------------------------------------"
            ' semgrep.json
      
            echo ""
            echo "---- GitHub Annotations ----"
      
            jq -r '
              .results[]
              | select(.extra.severity=="ERROR")
              | "::error file=\(.path),line=\(.start.line)::[\(.check_id)] \(.extra.message)"
            ' semgrep.json
      
            exit 1
          else
            echo "No high severity findings"
          fi
      
